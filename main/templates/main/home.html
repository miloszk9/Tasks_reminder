{% extends "main/index.html" %}

{% block content %}

<nav class="navbar navbar-expand navbar-dark bg-dark">
    <div class="container">
        <span class="navbar-brand mr-auto">
            <span class="navbar-brand d-block d-sm-none">TR</span>
            <span class="navbar-brand d-none d-sm-block">Tasks reminder</span>
        </span>

        <ul class="navbar-nav navbar-dark">
            <li class="nav-item form-inline">
                <form method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-light mr-1" name="previous" value={{date_change}}> < </button>
                </form>
            </li>
            <li class="nav-item text-light form-inline">
                <h3>{{date.day}}/{{date.month}}/{{date.year}}</h3>
            </li>
            <li class="nav-item form-inline">
                <form method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-light ml-2" name="next" value={{date_change}}> > </button>
                </form>
            </li>
        </ul>

        <!-- User section: username and logging out button -->
        <div class="navbar-nav ml-auto" id="user_section">
            <ul class="navbar-nav">
                <li class="nav-item mr-2 text-light mt-auto mb-auto d-none d-md-block">
                    <span>Hello, {{request.user}}</span>
                </li>
                <li class="nav-item">
                    <a href="{% url 'logout' %}"><button class="btn btn-outline-light">Sign out</button></a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="container pt-4 px-0">

    <!-- Adding new task form -->
    <div class="collapse pb-4" id="task_add">
        <div class="card card-body">
            <h4 class="card-title text-center pb-2">Create new task</h5>
            <form method="POST">
                {% csrf_token %}
                <div class="form-group row">
                    <label for="example-text-input" class="col-2 col-form-label">Task</label>
                    <div class="col-10">
                        <input class="form-control" name="task_name" type="text" id="example-text-input">
                    </div>
                </div>
                <div class="form-group row">
                    <label for="example-datetime-local-input" class="col-2 col-form-label">Date and time</label>
                    <div class="col-10">
                        <input id='input_date' class="form-control" name="task_date" type="datetime-local" value='0' id="example-datetime-local-input">
                    </div>
                </div>
                <button class="btn btn-outline-success btn-block" type="submit" value="1" name="new_task">Save</button>
            </form>
        </div>
    </div>

    <table class="table">

        <thead class="thead-dark">
            <tr>
                <th scope="col">Undone tasks</th>
                <th scope="col">Time</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            {% for record in db_data_undone %}
                <tr>
                    <th scope="row">
                        <span class="text-break">
                            {{record.name}}
                        </span>
                    </th>
                    <td>
                        <h4>{{record.date.hour}}:{{record.date.minute}}</h4>
                    </td>
                    <td>
                        <button class="btn btn-outline-dark" type="button" data-toggle="collapse" data-target="#task_edit{{record.id}}" aria-expanded="false" aria-controls="task_edit">
                            Edit task
                        </button>
                    </td>
                    <td>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="date_change" value={{date_change}}>
                            <button class="btn btn-success" type="submit" name="task_done_id" value={{record.id}}>Done!</button>
                        </form>
                    </td>
                </tr>

                <!-- Editing task form -->
                <div class="collapse pb-4" id="task_edit{{record.id}}">
                    <div class="card card-body">
                        <h4 class="card-title text-center pb-2">Edit task</h5>

                        <form method="POST">
                            {% csrf_token %}
                            <div class="form-group row">
                                <label for="text-input{{record.id}}" class="col-2 col-form-label">Task</label>
                                <div class="col-10">
                                    <input class="form-control" name="task_name" type="text" id="text-input{{record.id}}" value={{record.name}}>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for={{record.date.isoformat}} class="col-2 col-form-label">Date and time</label>
                                <div class="col-10">
                                    <input id={{record.date.isoformat}} class="form-control input_date_edit" name="task_date" type="datetime-local" value={{record.date.isoformat}}>
                                </div>
                            </div>
                            <button class="btn btn-outline-success" type="submit" value={{record.id}} name="edit_task">Save</button>
                        </form>
                    </div>
                </div>
            {% endfor %}

            <!-- Adding new task button -->
            <tr>
                <td colspan="4" class="text-center">
                    <button class="btn btn-secondary" type="button" data-toggle="collapse" data-target="#task_add" aria-expanded="false" aria-controls="task_add">
                            Add new task!
                    </button>
                </td>
            </tr>
        </tbody>
    
        <thead class="thead-dark">
            <tr>
                <th scope="col">Done tasks</th>
                <th scope="col">Time</th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            {% for record in db_data_done %}
                <tr>
                    <th scope="row">{{record.name}}</th>
                    <td>
                        <h4>{{record.date.hour}}:{{record.date.minute}}</h4>
                    </td>
                    <td>
                        <button class="btn btn-outline-dark" type="button" data-toggle="collapse" data-target="#task_edit{{record.id}}" aria-expanded="false" aria-controls="task_edit">
                            Edit task
                        </button>
                    </td>
                    <td>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="date_change" value={{date_change}}>
                            <button class="btn btn-danger" type="submit" name="task_done_id" value={{record.id}}>Undone!</button>
                        </form>
                    </td>
                </tr>
                <div class="collapse" id="task_edit{{record.id}}">
                    <div class="card card-body">
                        <form method="POST">
                            {% csrf_token %}
                            <div class="form-group row">
                                <label for="text-input{{record.id}}" class="col-2 col-form-label">Task</label>
                                <div class="col-10">
                                    <input class="form-control" name="task_name" type="text" id="text-input{{record.id}}" value={{record.name}}>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for={{record.date.isoformat}} class="col-2 col-form-label">Date and time</label>
                                <div class="col-10">
                                    <input id={{record.date.isoformat}} class="form-control input_date_edit" name="task_date" type="datetime-local" value={{record.date.isoformat}}>
                                </div>
                            </div>
                            <button class="btn btn-primary" type="submit" value={{record.id}} name="edit_task">Edit</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </tbody>
    </table>

    <script>
        // When creating new task
        // Matching default date with current one
        var time = new Date().toJSON();
        time = time.substring(0, time.length - 8);
        document.getElementById("input_date").value = time;

        // When editing task
        // Matching default edit date with original one
        for (var task of document.getElementsByClassName('input_date_edit')){
            date = task.id;
            time = date.substring(0, 16);
            task.value = time;
        }
    </script>
</main>
{% endblock content%}